<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body {
    font-family: Arial;
    padding: 20px;
    margin: 0;
    background-image: url('https://miro.medium.com/v2/resize:fit:1400/1*Lx2t7pemV__00FA15_Zckw.jpeg');
    background-repeat: no-repeat;
    background-position: center;
    background-attachment: fixed;
    background-size: cover;
    color: #000;
}

.header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 20px; 
    flex-wrap: wrap; 
}

.wert-box {
    background: rgba(255,255,255,0.85);
    padding: 10px 15px;
    border-radius: 8px;
    border: 2px solid #ccc;
    text-align: right;
    min-width: 220px;
}
.wert-box div {
    font-size: 1.1em;
    margin: 3px 0;
}

.controls { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 10px; 
    align-items: center; 
    background: rgba(255,255,255,0.8);
    padding: 10px;
    border-radius: 5px;
}

.gattungs-container { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 20px; 
    align-items: flex-start;
}

.gattung-box { 
    border: 2px solid #ccc; 
    padding: 10px; 
    flex: 1 1 auto; 
    min-width: 250px; 
    max-width: 32%; 
    background: rgba(255,255,255,0.8);
    border-radius: 5px;
}

.gattung-header {
    cursor: pointer;
    padding: 8px;
    background: rgba(200,200,200,0.6);
    border-radius: 5px;
    font-weight: bold;
    transition: background 0.2s;
    text-align: center;
}

.gattung-header:hover { background: rgba(180,180,180,0.8); }

.gattung-content {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.35s ease;
}

.gattung-box.open .gattung-content { max-height: 2000px; }

table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; font-size: 0.9em; }

button { padding: 2px 6px; margin: 0 2px; }
.green { background-color: #c8f0c8; }
.red { background-color: #f0c8c8; }

input[type="number"] { width: 60px; }

/* Login Overlay */
#loginBox {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: none; justify-content: center; align-items: center;
}
.loginWindow {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 350px;
}
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginBox">
    <div class="loginWindow">
        <h3>EDSM Login</h3>
        <label>Commander Name:</label>
        <input id="edsmName" type="text" style="width:100%; margin-bottom:10px;">

        <label>API Key:</label>
        <input id="edsmKey" type="password" style="width:100%; margin-bottom:15px;">

        <button onclick="saveLogin()" style="width:100%;">Login</button>
    </div>
</div>

<div class="header">
  <div class="controls">

    <!-- Planet Dropdown (neu) -->
    Planet:
    <select id="planetSelect">
      <option>Bitte EDSM Login...</option>
    </select>

    <button onclick="openLogin()">EDSM Login</button>
    <button onclick="logoutEDSM()">Logout</button>

    Druck: <input id="druck" type="number" step="0.01" value="0.03">
    Temperatur: von <input id="temp_min" type="number" value="0"> bis <input id="temp_max" type="number" value="200">
    Gravitation: <input id="grav" type="number" step="0.01" value="0.33">

    Atmosphäre: 
    <select id="atmos">
      <option>Kohlendioxid</option>
      <option>Neon</option>
      <option>Sauerstoff</option>
      <option>Ammoniak</option>
      <option>Methan</option>
      <option>Wasser</option>
      <option>Schwefeldioxid</option>
      <option>Stickstoff</option>
      <option>Helium</option>
      <option>Argon</option>
      <option>Jede</option>
    </select>

    Vulkanismus: 
    <select id="vulkan">
      <option>ohne</option>
      <option>Ammoniak</option>
      <option>Stickstoff</option>
      <option>Wasser</option>
      <option>Sauerstoff</option>
      <option>Methan</option>
      <option>Kohlendioxid</option>
    </select>

    Substanz:
    <select id="subst">
      <option>Eiswelt</option>
      <option>Felsige Eiswelt</option>
      <option>Felsige Welt</option>
      <option>Hochmetallhaltige Welt</option>
    </select>

    <button onclick="renderPlants()">Aktualisieren</button>
  </div>

  <div id="wert-box" class="wert-box">
      <div id="gesamtwert">Gesamtwert: 0</div>
      <div id="gesamtanzahl">Gesammelt: 0 Pflanzen</div>
  </div>
</div>

<div class="gattungs-container" id="gattungen"></div>

<script>
/* -------------------------------------------------------
   PFLANZEN-DATEN (gekürzt – du kannst hier deine 114 einsetzen)
--------------------------------------------------------- */
const plantsData = [
    { gattung: "Aleoida", name: "Arcus", wert: 7252500, gesammelt: 0,
      voraussetzungen: { druck:{min:0.02,max:0.1}, temperatur:{min:175,max:180},
      gravitation:{min:0.04,max:0.27}, atmosphaere:["Kohlendioxid"], vulkanismus:[],
      substanz:["Felsige Welt","Hochmetallhaltige Welt"] } }
];


/* -------------------------------------------------------
   LOCAL STORAGE LADEN
--------------------------------------------------------- */
function loadStorage() {
  const saved = localStorage.getItem("plantsSave");
  if (!saved) return;
  const parsed = JSON.parse(saved);
  plantsData.forEach(p => {
    if (parsed[p.name] !== undefined) p.gesammelt = parsed[p.name];
  });
}

/* -------------------------------------------------------
   LOCAL STORAGE SPEICHERN
--------------------------------------------------------- */
function saveStorage() {
  const saveObj = {};
  plantsData.forEach(p => saveObj[p.name] = p.gesammelt);
  localStorage.setItem("plantsSave", JSON.stringify(saveObj));
}


/* -------------------------------------------------------
   LOGIN FUNKTIONEN
--------------------------------------------------------- */
function openLogin() {
    document.getElementById("loginBox").style.display = "flex";
}

function saveLogin() {
    const name = document.getElementById("edsmName").value.trim();
    const key  = document.getElementById("edsmKey").value.trim();

    if (!name || !key) {
        alert("Bitte Name UND API-Key eingeben.");
        return;
    }

    localStorage.setItem("edsm_user", name);
    localStorage.setItem("edsm_key", key);

    document.getElementById("loginBox").style.display = "none";
    loadPlanetsFromEDSM();
}

function logoutEDSM() {
    localStorage.removeItem("edsm_user");
    localStorage.removeItem("edsm_key");
    alert("Logout erfolgreich.");
    document.getElementById("planetSelect").innerHTML = "<option>Bitte EDSM Login...</option>";
}


/* -------------------------------------------------------
   PLANETEN VON EDSM LADEN
--------------------------------------------------------- */
async function loadPlanetsFromEDSM() {
    const commander = localStorage.getItem("edsm_user");
    const apiKey    = localStorage.getItem("edsm_key");
    const select    = document.getElementById("planetSelect");

    if (!commander || !apiKey) {
        select.innerHTML = "<option>Bitte einloggen...</option>";
        return;
    }

    select.innerHTML = "<option>Lade Daten...</option>";

    try {
        const url = `https://www.edsm.net/api-logs-v1/get-bodies?commanderName=${encodeURIComponent(commander)}&apiKey=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();

        if (!data || !data.bodies) {
            select.innerHTML = "<option>Keine Planeten gefunden</option>";
            return;
        }

        const planets = data.bodies.filter(b => b.type === "Planet");

        select.innerHTML = "<option value=''>-- Planet wählen --</option>";

        planets.forEach(p => {
            const opt = document.createElement("option");
            opt.value = JSON.stringify(p);
            opt.textContent = `${p.name} (${p.system})`;
            select.appendChild(opt);
        });

    } catch (err) {
        console.error("EDSM Fehler:", err);
        select.innerHTML = "<option>Fehler beim Abruf</option>";
    }
}


/* -------------------------------------------------------
   PFLANZEN ANZEIGEN
--------------------------------------------------------- */
function checkVoraussetzungen(p) {
  const druck = parseFloat(document.getElementById('druck').value);
  const tempMin = parseFloat(document.getElementById('temp_min').value);
  const tempMax = parseFloat(document.getElementById('temp_max').value);
  const grav = parseFloat(document.getElementById('grav').value);
  const atmos = document.getElementById('atmos').value;
  const vulkan = document.getElementById('vulkan').value;
  const subst = document.getElementById('subst').value;

  let ok = true;

  if (druck < p.voraussetzungen.druck.min || druck > p.voraussetzungen.druck.max) ok = false;
  if (tempMax < p.voraussetzungen.temperatur.min || tempMin > p.voraussetzungen.temperatur.max) ok = false;
  if (grav < p.voraussetzungen.gravitation.min || grav > p.voraussetzungen.gravitation.max) ok = false;

  if (p.voraussetzungen.atmosphaere.length &&
      !p.voraussetzungen.atmosphaere.includes(atmos)) ok = false;

  if (p.voraussetzungen.vulkanismus.length &&
      !p.voraussetzungen.vulkanismus.includes(vulkan)) ok = false;

  if (p.voraussetzungen.substanz.length &&
      !p.voraussetzungen.substanz.includes(subst)) ok = false;

  return ok;
}


function renderPlants() {
  const container = document.getElementById('gattungen');
  container.innerHTML = '';

  const gattungen = [...new Set(plantsData.map(p => p.gattung))];

  gattungen.forEach(gattung => {
    const box = document.createElement('div');
    box.className = 'gattung-box';

    const header = document.createElement('div');
    header.className = 'gattung-header';
    header.innerText = gattung;

    const content = document.createElement('div');
    content.className = 'gattung-content';

    const table = document.createElement('table');
    const tbody = document.createElement('tbody');

    let shouldOpen = false;

    plantsData.filter(p => p.gattung === gattung).forEach(p => {
      const row = document.createElement('tr');
      const ok = checkVoraussetzungen(p);
      row.className = ok ? 'green' : 'red';

      if (ok) shouldOpen = true;

      row.innerHTML = `
        <td>${p.name}</td>
        <td>${p.wert.toLocaleString()}</td>
        <td id="cnt_${p.name}">${p.gesammelt}</td>
        <td>
          <button onclick="change('${p.name}', -1)">-</button>
          <button onclick="change('${p.name}', 1)">+</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    table.appendChild(tbody);
    content.appendChild(table);

    header.onclick = () => box.classList.toggle('open');

    if (shouldOpen) box.classList.add('open');

    box.appendChild(header);
    box.appendChild(content);
    container.appendChild(box);
  });

  updateGesamtwert();
}


/* -------------------------------------------------------
   SAMMELZAHL ÄNDERN
--------------------------------------------------------- */
function change(name, delta) {
  const plant = plantsData.find(p => p.name === name);
  if (!plant) return;

  plant.gesammelt = Math.max(0, plant.gesammelt + delta);
  document.getElementById('cnt_' + name).innerText = plant.gesammelt;

  saveStorage();
  updateGesamtwert();
}


/* -------------------------------------------------------
   GESAMTWERT
--------------------------------------------------------- */
function updateGesamtwert() {
  let total = 0;
  let count = 0;

  plantsData.forEach(p => {
    total += p.gesammelt * p.wert;
    count += p.gesammelt;
  });

  document.getElementById('gesamtwert').innerText =
      "Gesamtwert: " + total.toLocaleString();

  document.getElementById('gesamtanzahl').innerText =
      "Gesammelt: " + count + " Pflanzen";
}


/* -------------------------------------------------------
   START
--------------------------------------------------------- */
loadStorage();
renderPlants();

if (localStorage.getItem("edsm_user") && localStorage.getItem("edsm_key")) {
    loadPlanetsFromEDSM();
} else {
    openLogin();
}
</script>

</body>
</html>
